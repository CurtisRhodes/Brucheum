
@{
    ViewBag.Title = "Dashboard";
}
<script src="~/Scripts/jquery.signalR-2.4.0.min.js"></script>
<script src="/signalr/hubs"></script>
<style>
    .dashBoardContainer {
        display: flex;
        border: solid 2px #111;
    }
    .treeContainer {
        float:right;
        border-left: solid .5px #555;
        min-height: 106px;
        min-width: 275px;
        overflow-y: auto;
    }
    .workarea {
        float:left;
        width: 100%;
        background-color: #eee;
    }
    .collapsable {
        display: block;
    }
    .fileCount {
        display: inline;
        color: blue;
        font-size: smaller;
    }
    .loadingGif {
        left: 150px;
        top: 200px;
        height: 140px;
    }
    .addLinkCrudArea {
        font-size: 16px;
        border: solid .5px #555;
        padding: 6px;
    }
    .linkImage {
        /*
            float:right;
        height: 430px;
        min-width: 520px;

        */       
        max-width: 80%;
        border: solid .5px #555;
    }
    .roundedInput {
        display: inline-block;
        width: 97%;
        margin-right: 6px;
        font-size: 22px;
    }
    .roundendButton {
        margin-top: 6px;
        display: inline-block;        
    }
    .infoLine {
        position: absolute;
        bottom: 34px;
        display: none;
        padding: 4px;
        margin-left: 10px;
        border: solid .5px #555;
        height: 32px;
        min-width: 610px;
        background-color: #f8e8e8;
        vertical-align: bottom;
    }
    #dashboardTop {
    }
    .myH2 {
        font-family: Verdana;
        margin-top: 1px;
        font-size: 22px;
    }
    .linkContainer {
        margin-bottom: 4px;
        font-size: 12px;
    }
        .linkContainer div {
            display: inline;
            color: #585a38;
            margin-right: 22px;
        }

    .clickable {
        white-space: nowrap;
    }

</style>

<div class="threeColumnArray">
    <div id="leftColumn"></div>
    <div id="middleColumn">

        <div id="dashboardTop">
            <div class="myH2">Dashboard</div>

            <dir class="linkContainer">
                @*
        <div class="clickable" onclick="window.location.href='/stats/AdminDashboard'">Rebuild Tables</div>
        <div class="clickable" onclick="$('#addNewLink').show()">Add Link</div>
        <div class="clickable" onclick="buildFolderLinkTable()">build FolderLink Table</div>
        <div class="clickable" onclick="rebuildLinkTables()">Rebuild Link Tables</div>
        <div class="clickable" onclick="getCatTree()">Refresh Dir Tree</div>
                <div class="clickable" onclick="testConnection();">testConnection();</div>
                *@
                <div class="clickable" onclick="rebuildCatTree()">ReBuild Dir Tree</div>
                <div class="clickable" onclick="rebuildLinkTables()">ReBuild Link Tables</div>
                <div class="clickable" onclick="$('#videoCrud').fadeIn()">Add Video Link</div>
                <div class="clickable" onclick="$('#newFolderCrud').fadeIn()">Create New Folder</div>
                <div class="clickable" onclick="$('#moveFolderCrud').fadeIn()">Move Folder</div>
                <div class="clickable" onclick="$('#renameFolderCrud').fadeIn()">ReName Folder</div>
                <div class="clickable" onclick="$('#addFromPhysicalFolderCrud').fadeIn()">Up From Physical Folder</div>
                <div class="clickable" onclick="$('#repairLinksCrud').fadeIn()">Verify</div>
            </dir>
        </div>

        <img id="getDirTreeLoadingGif" class="loadingGif" src="~/Images/loader.gif" />
        <div id="divDashboardContainer" class="dashBoardContainer">

            <div class="workarea">
                <div id="divStatusMessage"></div>
                <div id="addNewLink" class="addLinkCrudArea">
                    <div>link<input id="txtNewLink" tabindex="1" class="roundedInput" onblur="previewLinkImage()" /></div>
                    <div>path<input class="txtLinkPath roundedInput" readonly="readonly" /></div>
                    <input type="hidden" id="txtHiddenLinkPathId" />
                    <div class="roundendButton" tabindex="2" onclick="addImageLink()">Insert</div>
                </div>
                <img id="imgLinkPreview" class="linkImage" />
                <div id="dataifyInfo" class="infoLine"></div>
            </div>
            <div id="dirTreeContainer" class="treeContainer">
                @Html.Partial("_DirTree")
            </div>

            <div id="videoCrud" class="floatingCrud">
                <div class="floatingCrudBanner">Add Video Link <div onclick="$('#videoCrud').fadeOut()" class="farSide">x</div> </div>
                <div class="floatingCrudContainer">
                    <div><span class="cru">link</span><input id="txtVideoLink" class="roundedInput" /></div>
                    <div><span>image</span><input id="txtVideoImage" class="roundedInput" /></div>
                    <div><span>title</span><input id="txtVideoTitle" class="roundedInput" /></div>
                    <div class="roundendButton" onclick="addVideo()">Insert</div>
                </div>
            </div>

            <div id="newFolderCrud" class="floatingCrud">
                <div class="floatingCrudBanner">Create New Folder<div onclick="$('#newFolderCrud').fadeOut()" class="farSide">x</div> </div>
                <div class="floatingCrudContainer">
                    <div><span>title</span><input id="txtNewFolderTitle" class="roundedInput" /></div>
                    <div><span>parent</span><input class="txtLinkPath roundedInput" readonly="readonly" /></div>
                    <div class="roundendButton" onclick="createNewFolder()">Create Folder</div>
                </div>
            </div>

            <div id="renameFolderCrud" class="floatingCrud">
                <div class="floatingCrudBanner">Rename Folder<div onclick="$('#renameFolderCrud').fadeOut()" class="farSide">x</div> </div>
                <div class="floatingCrudContainer">
                    @*<div><span>folder to rename</span><select id="selRenameFolder" class="dirTreeDropDown">@Html.Partial("_DirOptions");</select></div>*@
                    <div><span>folder to rename</span><input id="txtFolderToRename" class="txtLinkPath roundedInput" readonly="readonly" /></div>
                    <div><span>new name</span><input id="txtReName" class="roundedInput" /></div>
                    <div class="roundendButton" onclick="renameFolder()">Rename Folder</div>
                </div>
            </div>

            <div id="moveFolderCrud" class="floatingCrud">
                <div class="floatingCrudBanner">Move Folder<div onclick="$('#moveFolderCrud').fadeOut()" class="farSide">x</div> </div>
                <div class="floatingCrudContainer">
                    <div><span>folder to move</span><select id="selMoveFolder" class="dirTreeDropDown">@Html.Partial("_DirOptions");</select></div>
                    <div><span>new parent</span><input id="txtNewFolderParent" class="txtLinkPath roundedInput" readonly="readonly" /></div>
                    <div class="roundendButton" onclick="moveFolder()">Move Folder</div>
                </div>
            </div>

            <div id="addFromPhysicalFolderCrud" class="floatingCrud">
                <div class="floatingCrudBanner">Refresh From Physical Folder<div onclick="$('#addFromPhysicalFolderCrud').fadeOut()" class="farSide">x</div> </div>
                <div class="floatingCrudContainer">
                    <div><span>folder to update</span><select id="selVirtualFolder" class="dirTreeDropDown">@Html.Partial("_DirOptions");</select></div>
                    <div><span>physicalFolder</span><input id="txtphysicalFolder" class="roundedInput" /></div>
                    <div><span>danni path</span><input id="txtDanniPath" class="roundedInput" /></div>
                    <div class="roundendButton" onclick="addFromPhysicalFile()">add From Physical Folder</div>
                </div>
            </div>

            <div id="repairLinksCrud" class="floatingCrud">
                <div class="floatingCrudBanner">Verify Links<div onclick="$('#repairLinksCrud').fadeOut()" class="farSide">x</div> </div>
                <div class="floatingCrudContainer">
                    <div><span>destination</span><input id="txtdestination" value="F:/Danni/" class="roundedInput" /></div>
                    <div><span>start path</span><input class="txtLinkPath roundedInput" /></div>
                    <div class="roundendButton" onclick="repairLinks()">run</div>
                </div>
            </div>



        </div>
    </div>
    <div id="rightColumn"></div>
</div>

<script>
    var service = '@ViewBag.Service';    
    var tabIndent = 22;
    var tab = 0;
    var totalPics = 0;
    var totalFolders = 0;

    $(document).ready(function () {
        resizePage("resize from documant ready");
        resizeThisPage();    

    });

    function resizeThisPage() {
        var workAreaHeight = $('#dashboardTop').height() + ($('#dashboardTop').height() + $('#imgLinkPreview').height() + 300);
        if (workAreaHeight > $('#middleColumn').height()) {

        $('#middleColumn').height(workAreaHeight);
            //alert("workAreaHeight: " + workAreaHeight)
        }
        $('#divDashboardContainer').height($('#middleColumn').height() - 200);

        //$('#dirTreeContainer').height($();
        //$('#imgLinkPreview').height()
        
        $('.floatingCrud').width($('.workarea').width() - 100);
        $('#footerMessage').html("image height: " + $('#imgLinkPreview').height());

    };

    $(function () {

       // $.connection.hub.url = "https://api.curtisrhodes.com/signalr";

        var progress = $.connection.progressHub;
        console.log(progress);

        $.connection.hub.start().done(function () {
            var connectionId = $.connection.hub.id;
            console.log("connectionId: " + connectionId);
            //alert("connectionId: " + connectionId);
        });

        progress.client.addProgress = function (message, progressCount, totalItems) {
            alert("progress.client.addProgress: " + message);
            if (message == "...") {
                $('#dataifyInfo').show().html("processing: " + progressCount + " of " + totalItems);
            }
            else {
                $('#dataifyInfo').show().html(message);
            }
        };

    });

    function treeToggle(id) {
        //alert("id: " + id);
        //alert($('#' + id + '').css("display"));
        if ($('#' + id + '').css("display") == "none") {
            $('#S' + id + '').html("[-] ");
        }
        else
            $('#S' + id + '').html("[+] ");
        $('#' + id + '').toggle();
    }
    function clickPath(path, id) {
        $('.txtLinkPath').val(path.substring(6).replace(/%20/g, " "));
        $('#txtHiddenLinkPathId').val(id);
    }

    function addVideo() {
        try {
            $('#getDirTreeLoadingGif').show();
            var videoLink = {};
            videoLink.Link = $('#txtVideoLink').val();
            videoLink.Image = $('#txtVideoImage').val();
            videoLink.Title = $('#txtVideoTitle').val();
            $.ajax({
                type: "POST",
                url: service + "api/VideoLink",
                data: videoLink,
                success(success) {
                    $('#getDirTreeLoadingGif').hide();
                    if (!success.startsWith("ERROR")) {
                        displayStatusMessage("ok", "video link added");
                    }
                    else
                        alert("addVideo: " + success);
                },
                error: function (xhr) {
                    $('#getDirTreeLoadingGif').hide();
                    alert("addVideo xhr: " + getXHRErrorDetails(xhr));
                }
            })
        } catch (e) {
            alert("addVideo Catch : " + e);
        }


    }

    function previewLinkImage() {
        $('#imgLinkPreview').attr('src', $('#txtNewLink').val());

        $('#imgLinkPreview').one("load", function () {
            $('#footerMessage').html("ini image height: " + $('#imgLinkPreview').height());
            resizeThisPage();
        });
    }

    function addImageLink() {
        if (isNullorUndefined($('#txtNewLink').val()))
            alert("invalid link")
        else {
            $('#dataifyInfo').hide()
            var newLink = {};
            newLink.Link = $('#txtNewLink').val();
            newLink.FolderId = $('#txtHiddenLinkPathId').val();
            newLink.Path = $('.txtLinkPath').val().substring(6);
            $.ajax({
                type: "POST",
                url: service + "/api/ImageLinkCategory",
                data: newLink,
                success: function (success) {
                    if (success == "ok")
                        displayStatusMessage("ok", "image link added");

                    else {
                        alert("addImageLink: " + success);
                    }
                },
                error: function (xhr) {
                    alert("addImageLink xhr error: " + xhr.statusText);
                }
            });
        }
    }

    function createNewFolder() {
        $('#getDirTreeLoadingGif').fadeIn();
        var newFolder = {};
        newFolder.FolderName = $('#txtNewFolderTitle').val();
        newFolder.Parent = $('#txtHiddenLinkPathId').val();
        //newFolder.rootId = "";
        //
        $.ajax({
            type: "POST",
            url: service + "/api/ImageFolder/CreateFolder",
            data: newFolder,
            success: function (success) {
                $('#getDirTreeLoadingGif').hide();
                if (success == "ok") {
                    displayStatusMessage("ok", "new folder created");
                    rebuildCatTree();
                }
                else
                    alert("CreateVirtualFolder: " + success);
            },
            error: function (xhr) {
                $('#getDirTreeLoadingGif').hide();
                alert("CreateVirtualFolder xhr error: " + xhr.statusText);
            }
        });
    }

    function moveFolder() {
        var moveFolderModel = {};
        moveFolderModel.FolderToMoveId = $('#selMoveFolder').val();
        moveFolderModel.NewParentId = $('#txtHiddenLinkPathId').val();
        $('#getDirTreeLoadingGif').fadeIn();
        $.ajax({
            type: "PUT",
            url: service + "/api/ImageFolder",
            data: moveFolderModel,
            success: function (success) {
                $('#getDirTreeLoadingGif').hide();
                if (!success.startsWith("ERROR")) {
                    displayStatusMessage("ok", "folder " + $('#txtNewFolderParent').val() + " moved to " + success);
                    //$('#moveFolderCrud').fadeOut();
                    rebuildCatTree();
                }
                else
                    alert("Move Folder: " + success);
            },
            error: function (xhr) {
                $('#getDirTreeLoadingGif').hide();
                alert("Move Folder xhr error: " + xhr.statusText);
            }
        });
    }

    function renameFolder() {
        $.ajax({
            type: "PUT",
            url: service + "/api/ImageFolder/RenameFolder?folderId=" + $('#txtHiddenLinkPathId').val() + "&newName=" + $('#txtReName').val(),
            success: function (success) {
                $('#getDirTreeLoadingGif').hide();
                if (!success.startsWith("ERROR")) {
                    //$('#renameFolderCrud').fadeOut();                    
                    displayStatusMessage("ok", "folder " + $('.txtLinkPath').val() + " renamed to " + $('#txtReName').val());
                    rebuildCatTree();
                }
                else
                    alert("renameFolder: " + success);
            },
            error: function (xhr) {
                $('#getDirTreeLoadingGif').hide();
                alert("renameFolder xhr error: " + xhr.statusText);
            }
        });

    }

    var optionTree = "";
    function rebuildCatTree() {
        try {
            var start = Date.now();
            $('#dataifyInfo').show().html("rebuilding directory tree");
            $('#getDirTreeLoadingGif').fadeIn();
            totalPics = 0;
            totalFolders = 0;
            tab = 0;

            //alert("url: " + service + "/api/ImageLinkCategory");
            $('#dirTreeContainer').html("");
            $.ajax({
                type: "GET",
                url: service + "/api/ImageLinkCategory",
                success: function (danni) {
                    recurrGetCatTree(danni, 'dirTreeContainer');

                    var delta = (Date.now() - start) / 1000;
                    console.log("rebuildCatTree took: " + delta.toFixed(3));
                    $('#dataifyInfo').html("rebuildCatTree took: " + delta.toFixed(3) + " total folders: " + totalFolders + " total pics: " + totalPics);
                    saveAsStaticFile("dirTree");
                    saveAsStaticFile("dirSelect");
                    $('#getDirTreeLoadingGif').hide();
                },
                error: function (xhr) {
                    $('#getDirTreeLoadingGif').hide();
                    alert("buildCatTree xhr error: " + xhr.statusText);
                }
            });
        } catch (e) {
            $('#getDirTreeLoadingGif').hide();
            alert("buildCatTree catch: " + e);
        }
    }
    function recurrGetCatTree(dir, container) {
        tab += tabIndent;
        $.each(dir.SubDirs, function (idx, subDir) {

            $('#' + container + '').append("<div class='clickable' style='text-indent:" + tab + "px'>"
                + "<span id=S" + subDir.LinkId + " onclick=treeToggle('" + subDir.LinkId + "')>[-] </span>"
                + "<span onclick=clickPath('" + subDir.DanniPath + "','" + subDir.CategoryId + "')>" + subDir.DirectoryName +
                "</span><span class='fileCount'>  : " + subDir.Length + "</span></div>");
            $('#' + container + '').append("<div id=" + subDir.LinkId + " class='zzcollapsable'></div>");

            optionTree += "<option value='" + subDir.CategoryId + "'>";
            var optTab = tab;
            //alert("optTab: " + optTab)
            while (optTab > 0) {
                optionTree += " - ";
                optTab -= tabIndent;
                //alert("optTab w: " + optTab)
            }
            optionTree += subDir.DirectoryName + "</option > ";

            totalPics += subDir.Length;
            totalFolders++;
            recurrGetCatTree(subDir, subDir.LinkId);
            tab -= tabIndent;




        });
    }
    function saveAsStaticFile(fileName) {
        try {

            var data = new Object();
            if (fileName == "dirTree") {
                data.html = $('#dirTreeContainer').html();
                data.fileName = "_DirTree.cshtml";
                $('#dataifyInfo').append(" Create DirTree");
            }
            if (fileName == "dirSelect") {
                data.html = optionTree;
                data.fileName = "_DirOptions.cshtml";
                $('#dataifyInfo').append(" Create DirOptions");
            }
            //alert("Create Static File")
            
            $.ajax({
                type: "POST",
                url: "/Stats/CreateStaticFile",
                data: JSON.stringify(data),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (success) {
                    if (success === "ok") {
                        //$('#dataifyInfo').show().html(data.fileName + " saved");
                        $('#dataifyInfo').append(" ok");
                    }
                    else
                        alert("CreateStaticFile: " + success);
                },
                error: function (jqXHR, exception) {
                    alert("CreateStaticFile XHR error: " + getXHRErrorDetails(jqXHR, exception));
                }
            });
        } catch (e) {
            alert("CreateStaticFile CATCH: " + success);
        }
    }

    function rebuildLinkTables() {
        try {
            $('#dataifyInfo').show().html("rebuilding Link Tables");
            $('#getDirTreeLoadingGif').fadeIn();
            $.ajax({
                type: "PUT",
                url: service + "/api/ImageLink",
                success: function (success) {
                    $('#getDirTreeLoadingGif').hide();
                    if (success == "ok")
                        $('#dataifyInfo').append(" ok");
                    else
                        alert("rebuildLinkTables: " + success);
                },
                error: function (jqXHR, exception) {
                    $('#getDirTreeLoadingGif').hide();
                    alert("update Article jqXHR : " + getXHRErrorDetails(jqXHR, exception));
                }
            });
        } catch (e) {
            $('#getDirTreeLoadingGif').hide();
            alert("rebuildLinkTables catch: " + e);
        }
    }

    function repairLinks() {
        var start = Date.now();
        $('#dataifyInfo').show().html("checking and repairing links");

        var rootId = $('#txtHiddenLinkPathId').val();        
        var destination = $('#txtdestination').val(); // "f:/Danni/";
        $('#getDirTreeLoadingGif').fadeIn();
        $.ajax({
            type: "POST",
            url: service + "/api/Directory/Repair?rootId=" + rootId + "&destination=" + destination,
            success: function (repairReport) {
                $('#getDirTreeLoadingGif').hide();
                if (repairReport.Success=="ok") {
                    var delta = (Date.now() - start);
                    var minutes = Math.floor(delta / 60000);
                    var seconds = ((delta % 60000) / 1000).toFixed(0);
                    console.log("rebuildCatTree took: " + minutes + ":" + (seconds < 10 ? '0' : '') + seconds);
                    //$('#downloadLinksCrud').fadeOut();
                    $('#dataifyInfo').html("download links from " + repairReport.FolderName + " took: " + minutes + ":" + (seconds < 10 ? '0' : '') + seconds);
                    //$('#dataifyInfo').append(" errors: " + repairReport.ErrorArray.Length);
                    $('#dataifyInfo').append(". links edited: " + repairReport.LinksEdited);
                    $('#dataifyInfo').append(",  images renamed: " + repairReport.ImagesRenamed);
                    $('#dataifyInfo').append(", links added: " + repairReport.NewLinksAdded);
                    $('#dataifyInfo').append(", missing links: " + repairReport.LinksRemoved);
                }
                else
                    alert("downloadLinks: " + repairReport.Success);
            },
            error: function (xhr) {
                $('#getDirTreeLoadingGif').hide();
                alert("downloadLinks xhr error: " + xhr.statusText);
            }
        });
    }

    $(document).keydown(function (event) {
        // Number 13 is the "Enter" key on the keyboard
        if (event.keyCode === 13) {
            // Cancel the default action, if needed
            // Trigger the button element with a click
            addImageLink();
        }
    });

</script>
