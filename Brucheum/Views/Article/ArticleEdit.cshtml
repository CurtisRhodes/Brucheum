@{
    ViewBag.Title = "Article Edit";
}

<link href="~/Styles/articleEdit.css" rel="stylesheet" />
<script src="~/Scripts/ImageTools.js"></script>

<div class="threeColumnArray">
    <div id="leftColumn"></div>
    <div id="middleColumn">
        <div id="divLoadingGif" class="loadingGif"><img src="~/Images/loader.gif" /></div>
        <div id="divAjustableItemsWrapper">
            <div id="divEditArticleContainer" class="editArticleContainer">
                <div id="divArticleRowContainer" class="editArticleRowContainer">
                    <div class="editArticleRow">
                        <div class="editArticleLabel">Title:</div>
                        <div class="editArticleInput"><input class="roundedInput wide" id="txtTitle" /></div>
                    </div>
                    <div class="editArticleRow">
                        <div class="editArticleLabel">Category:</div>
                        <div class="editArticleInput"><select id="ddCategory" class="roundedInput"></select></div>
                        <div class="editArticleLabel align-right">Byline:</div>
                        <div class="editArticleInput"><select id="ddAvatars" class="roundedInput"></select></div>
                        <div class="editArticleLabel align-right">Created:</div>
                        <div class="editArticleInput"><input class="roundedInput" id="txtCreated" /></div>
                    </div>
                    <div class="editArticleRow">
                        <div class="editArticleLabel">Image:</div>
                        <div class="editArticleInput"><input id="uplImage" type="file" class="imageUpload wide" /></div>
                    </div>
                    <div class="editArticleRow">
                        <div class="editArticleLabel">Meta Tag:</div>
                        <div class="editArticleInput"><input class="roundedInput" id="txtMetaTag" /></div>
                        <div id="divTagContainer" class="tagContainer"></div>
                    </div>
                    <div class="editArticleRow">
                        <div id="divEditArticleLabel" class="editArticleLabel">Summary:</div>
                        <div class="editArticleInput"><textarea id="txaSummary" class="articleSummary"></textarea></div>
                    </div>
                </div>
                <div id="#divEditArticlePicContainer" class="editArticlePicContainer">
                    <img id="imgArticleJog" />
                </div>
            </div>
            <div id="divStatusMessage"></div>
            <div id="articleEditor">
                <div>@Html.Partial("_Editor") </div>
            </div>
            @*<div id="divQuilleditor"></div>*@

            <div id="divButtons">
                <button id="btnSave" class="roundendButton">Save</button>
                <button id="btnView" class="roundendButton">View</button>
                <button id="btnDelete" class="roundendButton">Delete</button>
            </div>
            @*<input id="hiddenId" type="hidden" />*@
            <input id="hiddenImageName" type="hidden" />
        </div>
    </div>
    <div id="rightColumn"></div>
</div>

<script>
    var service = '@ViewBag.Service';
    var articleId = '@ViewBag.ArticleId';
    var article = new Object();
    var metaTags = new Array();

    //var quill = new Quill('#divQuilleditor', { theme: 'snow' });
    //var quill = new Quill('#divQuilleditor', { theme: 'snow', modules: { toolbar: '#full-toolbar' } 	});

    $(document).ready(function () {
        //$('#divLoadingGif').show();

        getCategories()
        getAvatars()
        if (articleId !== "") {
            getArticle();
        }
        else {
            $('#txtCreated').val(formatDate(new Date()));
        }
        $('#btnDelete').hide();
        $('#articleEditor').summernote({
            height: 222,
            codemirror: { mode: "htmlmixed", theme: "monokai" },
            toolbar: [
                ['codeview'],
                ['style', ['bold', 'italic', 'underline', 'clear']],
                ['font', ['strikethrough', 'superscript', 'subscript']],
                ['fontsize', ['fontname', 'fontsize']],
                ['insert', ['picture', 'link', 'video', 'table', 'hr']],
                ['color', ['color']],
                ['para', ['ul', 'ol', 'paragraph']],
                ['height', ['height']]
            ]
        });
    });

    function bind(article) {
        //$('#hiddenId').val(article.Id );
        $('#txtTitle').val(article.Title);
        $('#ddCategory').val(article.Category);
        //alert("article.Category: " + article.Category)
        $('#txaSummary').val(article.Summary);
        $('#hiddenImageName').val(article.ImageName);
        $('#ddAvatars').val(article.Byline);
        $('#txtCreated').val(article.DateCreated);
        $('#articleEditor').summernote('code', article.Contents);
    }

    function unBind() {
        try {
            article.Id = articleId; //$('#hiddenId').val();
            article.Title = $('#txtTitle').val();
            article.Category = $('#ddCategory option:selected').text();
            article.Summary = $('#txaSummary').val();
            article.ImageName = $('#hiddenImageName').val();
            article.Byline = $('#ddAvatars option:selected').text();
            article.DateCreated = $('#txtCreated').val();
            article.Contents = beautify($('#articleEditor').summernote('code'));
            //article.Contents = quill.root.innerHTML;  //quill.getContents(0, quill.getLength()).innerHtml;
            article.Tags = metaTags;
        }
        catch (e) {
            alert("unBind: " + e);
        }
    }

    function updateArticle(view) {
        try {
            unBind();
            $.ajax({
                type: "PUT",
                url: service + "/api/Article",
                async: "false",
                dataType: "json",
                data: article,
                success: function (success) {
                    if (success === "ok")
                        if (view === "View")
                            window.location = "Article?Id=" + articleId; // $('#hiddenId').val();
                        else
                            displayStatusMessage("severityOk", "updated");
                    else
                        displayStatusMessage("severityError", success);
                },
                error: function (xhr) {
                    displayStatusMessage("severityError", "error: " + xhr.statusText);
                    alert("ArticleEdit PUT error: " + xhr.statusText);
                }
            });
        } catch (e) {
            displayStatusMessage("severityError", "ERROR"  + e);
        }
    }

    function postArticle(view) {
        try {
            unBind();
            if (article.Title === "") {
                displayStatusMessage("severityWarning", "Title Required");
                return;
            }
            $.ajax({
                url: service + "/api/Article",
                type: "post",
                dataType: "Json",
                data: article,
                success: function (newArticleId) {
                    articleId = newArticleId;
                    //$('#hiddenId').val(result);
                    if (view === "View") {
                        window.location = "Article?Id=" + newArticleId;  //$('#hiddenId').val();
                    }
                    else {
                      //  alert("result: " + result);
                        displayStatusMessage("severityOk", "Saved");
                        $('#btnSave').text("Update");
                    }
                },
                error: function (xhr) {
                    displayStatusMessage("severityError", "error: " + xhr.statusText);
                    alert("postArticle error: " + xhr.statusText);
                }
            });
        } catch (e) {

            displayStatusMessage("severityError", "catch ERROR: "  + e);
        }
    }

    function getArticle() {
        $.ajax({
            url: service + "/api/Article?id=" + articleId,
            type: "get",
            dataType: "json",
            success: function (response) {
                bind(response);
                if (response.ImageName !== "") {
                    //var image = getImage(service, response.ImageName);
                    //$('#bImage').attr("src", "data:image/gif;base64," + image);
                    //$('#imgArticleJog').attr("src", response.ImageName);
                    $('#imgArticleJog').attr("src", service + "/App_Data/Images/" + response.ImageName);
                }
                $('#btnSave').text("Update");
                if (response.Tags != "") {
                    metaTags = response.Tags;
                    for (var tag in metaTags) {
                        $("#divTagContainer").append("<div class='tagItem'>" + metaTags[tag] + "</div>");
                    };
                }
                setTimeout(function () { adjust() }, 1000);
            },
            error: function (xhr, textStatus, error) {
                displayStatusMessage("severityError", "status: " + textStatus + "text: " + xhr.statusText + "error: " + error);
                alert("status: " + textStatus + "text: " + xhr.statusText + "error: " + error);
            }
        });
    }

    function getCategories() {
        $.ajax({
            url: service + "/api/Ref?refType=CAT",
            type: "get",
            dataType: "json",
            success: function (response) {
                $('#ddCategory').html("<option class= 'ddOption' value ='0'>-- select category --</option >");
                $.each(response, function (idx, obj) {
                    //obj = obj.split(",");
                    $('#ddCategory').append("<option class='ddOption' value='" + obj.RefDescription + "'>" + obj.RefDescription + "</option>");
                });
            },
            error: function (xhr, textStatus, error) {
                displayStatusMessage("severityError", "status: " + textStatus + "text: " + xhr.statusText + "error: " + error);
                alert("status: " + textStatus + "text: " + xhr.statusText + "error: " + error);
            }
        });
    };

    function getAvatars() {
        $.ajax({
            url: service + "/api/Ref?refType=AVT",
            type: "get",
            dataType: "json",
            success: function (response) {
                $('#ddAvatars').html("<option class= 'ddOption' value ='0'>-- select avatar --</option >");
                $.each(response, function (idx, obj) {
                    //obj = obj.split(",");
                    $('#ddAvatars').append("<option class='ddOption' value='" + obj.RefDescription + "'>" + obj.RefDescription + "</option>");
                });
            },
            error: function (xhr, textStatus, error) {
                displayStatusMessage("severityError", "status: " + textStatus + "text: " + xhr.statusText + "error: " + error);
                alert("status: " + textStatus + "text: " + xhr.statusText + "error: " + error);
            }
        });
    };

    $('#txtMetaTag').blur(function () {
        if ($('#txtMetaTag').val() !== "") {
            metaTags.push($('#txtMetaTag').val());
            $('#divTagContainer').append("<div class='tagItem'>" + $('#txtMetaTag').val() + "</div>");;
            $('#txtMetaTag').val("");
        }
    });

    $('#uplImage').change(function () {
        var localImageName = $('#uplImage').val();
        var serverImageName = postImage(service, localImageName);
        $('#hiddenImageName').val(serverImageName);
        $('#imgArticleJog').attr("src", service + "/App_Data/Images/" + serverImageName);
        //var bytes = getImage(service, serverImageName);
        //$('#bImage').attr("src", "data:image/gif;base64," + bytes);
    });

    $('#btnSave').click(function () {
        if ($('#btnSave').text() === "Save")
            postArticle();
        else
            updateArticle();
    });

    $('#btnView').click(function () {
        if ($('#btnSave').text() === "Save")
            postArticle("View");
        else
            updateArticle("View");
    });

    function adjust() {
        var wPic = $('#imgArticleJog').width();
        var wAcl = $('#divEditArticleContainer').width();

        $('#divArticleRowContainer').width(wAcl - wPic);
        var wAcr = $('#divArticleRowContainer').width();

        //alert("ArticleContainer: " + wAcl + " pic: " + wPic + " RowContainer: " + wAcr);

        var wlbl = $('#divEditArticleLabel').width() + 20;
        //alert("ArticleLabel: " + wlbl);        
        //var start = $('#txaSummary').width();
        $('#txaSummary').width(wAcr - wlbl);
        //var wNow = $('#txaSummary').width();

        //alert("txtArea start: " + start + " now: " + wNow);
        //$('#divLoadingGif').hide();
        //$('#divAjustableItemsWrapper').show();
    }

</script>

