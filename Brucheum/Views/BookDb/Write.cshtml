@{
    ViewBag.Title = "Write";
}

<script src="~/Scripts/EditorToolbar.js"></script>

<link href="~/Styles/crudEdit.css" rel="stylesheet" />
<link href="~/Styles/tableofContents.css" rel="stylesheet" />

<style>
    .crudContainer {
        width: 100%;
    }

    .writeRow {
        margin: 5px;
        /*
            margin-top: 10px;
            padding: 0 22px;
            white-space: nowrap;

        */
        display: none;
    }

    .chapterNumberSize {
        width: 50px;
    }

    #txtSectionTitle {
        width: 70%;
        margin-bottom: 14px;
    }

    .nestedList {
        height: 400px;
        overflow-y: auto;
    }

    #sectionList {
        margin-top: 14px;
    }

    #subSectionRow {
        display: none;
        padding-bottom: 14px;
    }

    .threeColumnArray {
        /*background-image: url('../../Images/parchment01.jpg');
        background-repeat: no-repeat;
        background-size: 100%;*/
        background-color: #ddd69f;
    }

    .bookSectionSpinnerOffset {
        top: 10px;
        left: 30px;
    }

    .nestedListItem {
        padding: 4px;
        cursor: pointer;
        margin-bottom: 5px;
        background-color: #74bac3;
        border-radius: 5px;
        /*float: left;*/
        white-space: nowrap;
    }

    .nestedListBookItem {
        font-weight: bold;
        padding-left: 4px;
    }

    .nestedListChapterItem {
        padding-left: 8px;
    }

    .nestedListSectionItem {
        padding-left: 50px;
    }

    .nestedListSubSectionItem {
        padding-left: 100px;
    }

    .caret12 {
        height: 12px;
    }

    .dots95 {
        float: left;
        border-bottom: dotted 5px #214c87;
        width: 95%;
    }
</style>

<div class="threeColumnArray">
    <div id="leftColumn"></div>
    <div id="middleColumn">
        <div id="pageBookTitle" class="pageTitle" onclick="redirectToToC()"></div>
        @*<a class="crudBreadcrumb" href="javascript:redirectToToC()">&#8592;</a>*@
        <div class="crudContainer floatLeft">
            <div id="crudTopBorderHeader" class="crudContainerTitle"></div>
            <div id="sectionsCrudArea" class="crudArea">

                <div id="bookRow" class="writeRow">
                    <div class="crudRowLabel">Book Title</div>
                    <input id="txtBookTitle" class="roundedInput" />
                    <div>
                        <div class="crudRowLabel"></div>
                        <input id="radioIntro" type="radio" class="bookRadioButtons" onclick="toggleBookRadioButtons('Introduction')" checked="checked">  Introduction
                        <input id="radioPreface" type="radio" class="bookRadioButtons" onclick="toggleBookRadioButtons('Preface')">  Preface
                    </div>
                </div>

                <div id="chapterRow" class="writeRow">
                    <div class="crudRowLabel">Chapter Number</div>
                    <input id="txtChapterOrder" class="roundedInput chapterNumberSize" />
                    <div class="crudRowLabel">Chapter Title</div>
                    <input id="txtChapterTitle" class="roundedInput width60px" />
                    <div class="crudLabel">Preface</div>
                </div>

                <div id="sectionRow" class="writeRow">
                    <div class="crudRowLabel">Section Number</div>
                    <input id="txtSectionOrder" class="roundedInput chapterNumberSize" />
                    <div class="crudRowLabel">Section Title</div>
                    <input id="txtSectionTitle" class="roundedInput" />
                </div>

                <div id="subSectionRow" class="writeRow">
                    <div class="crudRowLabel">SubSection Number</div>
                    <input id="txtSubSectionOrder" class="roundedInput chapterNumberSize" />
                    <div class="crudRowLabel">SubSection Title</div>
                    <input id="txtSubSectionTitle" class="roundedInput" />
                </div>

                <div id="sectionEditor" class="editorContainer">
                    @Html.Partial("_Editor")
                </div>
                <div id="divStatusMessage"></div>

                <div>
                    <img id="bookSectionSpinner" class="btnSpinnerImage bookSectionSpinnerOffset" src="~/Images/loader.gif" />

                    <button id="btnAddUpdateBook" class="roundendButton allBookButtons" onclick="addUpdateBook()">Add</button>
                    <button id="btnNewBook" class="roundendButton allBookButtons" onclick="toggleNewBook()">New Book</button>

                    <button id="btnAddUpdateChapter" class="roundendButton allBookButtons" onclick="addUpdateChapter()">Add</button>
                    <button id="btnNewChapter" class="roundendButton allBookButtons" onclick="toggleNewChapter()">New Chapter</button>

                    <button id="btnAddUpdateSection" class="roundendButton allBookButtons" onclick="addUpdateSection()">Add</button>
                    <button id="btnNewSection" class="roundendButton allBookButtons" onclick="toggleNewSection()">New Section</button>

                    <button id="btnAddUpdateSubSection" class="roundendButton allBookButtons" onclick="addUpdateSubSection()">New Subsection</button>
                    <button id="btnNewSubSection" class="roundendButton allBookButtons" onclick="toggleNewSubSection()">New Subsection</button>

                </div>
                <div>
                    <div id="writeSectionsListLoadingGif" class="loadingGif"><img src="~/Images/loader.gif" /></div>
                    <div id="nestedBookChaptersList" class="crudList nestedList"></div>
                </div>
            </div>
        </div>
    </div>
    <div id="rightColumn"></div>
</div>


<script>
/// ready fire aim
/// set up an editor screen for sections and subsections
/// you have already picked the chapter -- or this could be a drop down
///  combining write and edit pages
///
///
    var service = '@ViewBag.Service';
    var bookId = '@ViewBag.BookId';
    var bookModel = {};
    var sectionModel = {};
    var chapterModel = {};

    $(document).ready(function () {
        if (isNullorUndefined(bookId)) {
            window.location.href = "/BookDb"
        }
        $('.allBookButtons').hide();
        setUpSummerNoteEditor();
        //setToolbar("#sectionEditor", 220, 500);
        loadNestedList();
    })

    function setUpSummerNoteEditor() {
        $('#sectionEditor').summernote({
            height: 200,
            codemirror: { lineWrapping: true, mode: "htmlmixed", theme: "monokai" },
            toolbar: [
                ['codeview'],
                ['style', ['bold', 'italic', 'underline', 'clear']],
                //['font', ['strikethrough', 'superscript', 'subscript']],
                ['fontsize', ['fontname', 'fontsize']],
                //['insert', ['picture', 'link', 'video', 'table', 'hr']],
                ['color', ['color']]
                //['para', ['ul', 'ol', 'paragraph']],
                //['height', ['height']]
            ]
        });
    }

    function loadBookDetails() {
        bookModel.Id = bookId;
        $('#sectionEditor').summernote('code', bookModel.Introduction);
        $('#txtBookTitle').val(bookModel.BookTitle);

        $('.allBookButtons').hide();
        $('#btnAddUpdateBook').show().html("Update");
        $('#btnNewBook').show();
        
        $('.writeRow').hide();
        $('#bookRow').show();
    }
    function toggleNewBook() {
        $('#btnAddUpdateBook').show().html("Add");
        $('#btnNewBook').hide();
    }
    function toggleBookRadioButtons(editContents) {
        //alert("setBookEditor: " + editContents);
        if (editContents == "Preface") {
            bookModel.Introduction = $('#sectionEditor').summernote('code');
            $('#sectionEditor').summernote('code', bookModel.Preface);
            $('#radioIntro').attr('checked', false);
        }
        if (editContents == "Introduction") {
            bookModel.Preface = $('#sectionEditor').summernote('code');
            $('#sectionEditor').summernote('code', bookModel.Introduction);
            $('#radioPreface').attr('checked', false);
        }
    }
    function addUpdateBook() {
        if ($('#btnAddUpdateBook').html() == "Update") {
            alert("add new book")
        }
        if ($('#btnAddUpdateBook').html() == "Add") {
            alert("add new book")
            $('#btnAddUpdateBook').show().html("Update");
            $('#btnNewBook').show();
        }
}

    function loadChapterDetails(chapterId) {
        try {
            $.ajax({
                type: "PATCH",
                url: service + "/api/Chapter/?chapterId=" + chapterId,
                success: function (chapter) {
                    if (chapter.success == "ok") {
                        $('#crudTopBorderHeader').html("Chapter " + chapter.ChapterOrder + ".    " + chapter.ChapterTitle);

                        $('#txtChapterOrder').val(chapter.ChapterOrder)
                        $('#txtChapterTitle').val(chapter.ChapterTitle)
                        $('#sectionEditor').summernote('code', chapter.Preface);

                        $('.writeRow').hide();
                        $('#chapterRow').show();
                        $('.allBookButtons').hide();
                        $('#btnAddUpdateChapter').html("Update").show();
                        $('#btnNewChapter').show();
                    }
                    else
                        alert("getChapter: " + chapter.success)
                },
                error: function (jqXHR, exception) {
                    alert("getChapter XHR error: " + getXHRErrorDetails(jqXHR, exception));
                }
            });
        } catch (e) {
            alert("getChapter CATCH: " + e);
        }
    }
    function addUpdateChapter() {
        chapterModel.BookId = bookId;
        chapterModel.ChapterTitle = $('#txtChapterTitle').val();
        chapterModel.ChapterOrder = $('#txtChapterOrder').val();
        chapterModel.Preface = $('#sectionEditor').summernote('code');

        if ($('#btnAddUpdateChapter').html() == "Add") {
            try {
                $.ajax({
                    type: "Post",
                    url: service + "/api/Chapter",
                    data: chapterModel,
                    success: function (chapterId) {
                        chapterModel.Id = chapterId;
                        displayStatusMessage("ok", chapterModel.ChapterTitle + " Added");
                    },
                    error: function (jqXHR, exception) {
                        alert("add chapter XHR error: " + getXHRErrorDetails(jqXHR, exception));
                    }
                });
            } catch (e) {
                alert("add chapter CATCH: " + e);
            }
        }
        if ($('#btnAddUpdateChapter').html() == "Update") {
            try {
                $.ajax({
                    type: "Put",
                    url: service + "/api/Chapter",
                    data: chapterModel,
                    success: function (success) {
                        if (success === "ok") {
                            displayStatusMessage("ok", chapterModel.ChapterTitle + " updated");
                            getChapters();
                        }
                        else
                            alert("updateChapter: " + success);
                    },
                    error: function (jqXHR, exception) {
                        alert("update chapter XHR error: " + getXHRErrorDetails(jqXHR, exception));
                    }
                });
            } catch (e) {
                alert("update Chapter CATCH: " + e);
            }
        }
    }
    function toggleNewChapter() {
        $('.allBookButtons').hide();
        $('#btnAddUpdateChapter').html("Add").show();
    }

    function loadSectionDetails(chapterId, sectionId) {
        //alert("loadSectionDetails :" + sectionId);
        try {
            $.ajax({
                type: "PATCH",
                url: service + "/api/BookSection/?sectionId=" + sectionId,
                success: function (section) {

                    $('#crudTopBorderHeader').html("Chapter " + section.ChapterOrder + ".    " + section.ChapterTitle);

                    sectionModel.Id = sectionId;
                    $('#txtSectionTitle').val(section.SectionTitle);
                    $('#txtSectionOrder').val(section.SectionOrder);
                    $('#sectionEditor').summernote('code', section.SectionContents);

                    $('.writeRow').hide();
                    $('#sectionRow').show();
                    $('.allBookButtons').hide();
                    $("#btnAddUpdateSection").html("Update").show();
                    $('#btnNewSection').show();
                    $('#btnAddUpdateSubSection').html("New Subsection").show();
                },
                error: function (jqXHR, exception) {
                    alert("loadSectionDetails XHR error: " + getXHRErrorDetails(jqXHR, exception));
                }
            });
        } catch (e) {
            alert("loadSectionDetails CATCH: " + e);
        }
    }


    function addUpdateSection() {
        $('#bookSectionSpinner').show();
        sectionModel.SectionTitle = $('#txtSectionTitle').val();
        sectionModel.SectionOrder = $('#txtSectionOrder').val();
        sectionModel.SectionContents = $('#sectionEditor').summernote('code');
        try {
            if ($('#btnAddUpdateSection').html() == "Add") {
                $.ajax({
                    type: "POST",
                    url: service + "/api/BookSection/",
                    data: sectionModel,
                    success: function (sectionId) {
                        sectionModel.Id = sectionId;
                        displayStatusMessage("ok", sectionModel.SectionTitle + " Added");
                        $('#btnAddUpdateSection').html("Update");
                        $('#btnNewCancel').html("New");
                        $("#btnContinue").show();
                        loadSectionList();
                        $('#bookSectionSpinner').hide();
                    },
                    error: function (jqXHR, exception) {
                        $('#bookSectionSpinner').hide();
                        alert("addSection XHR error: " + getXHRErrorDetails(jqXHR, exception));
                    }
                });
            }
            if ($('#btnAddUpdateSection').html() == "Update")
            {
                sectionModel.SectionTitle = $('#txtSectionTitle').val();
                sectionModel.SectionOrder = $('#txtSectionOrder').val();
                sectionModel.SectionContents = $('#sectionEditor').summernote('code');
                $.ajax({
                    type: "PUT",
                    url: service + "/api/BookSection/",
                    data: sectionModel,
                    success: function (success) {
                        $('#bookSectionSpinner').hide();
                        if (success == "ok") {
                            displayStatusMessage("ok", sectionModel.SectionTitle + " Updated");
                            loadSectionList();
                        }
                        else
                            alert("success: " + success);
                    },
                    error: function (jqXHR, exception) {
                        $('#bookSectionSpinner').hide();
                        alert("getChapter XHR error: " + getXHRErrorDetails(jqXHR, exception));
                    }
                });
            }
        } catch (e) {
            $('#bookSectionSpinner').hide();
            alert("addSection CATCH: " + e);
        }
    }
    function toggleNewSection() {
        // clear
        sectionModel.Id = null;
        $('#sectionEditor').summernote('code', "");
        $('#txtSectionTitle').val("");
        $('#txtSectionOrder').val("");
        $('#btnAddUpdateSection').html("Add");
        $('#btnNewSection').hide();
        $('#btnAddUpdateSubSection').hide();
        $('#btnNewSubSection').hide();
    }

    function loadSubSectionDetails(subSectionId) {
        try {
            $.ajax({
                type: "PATCH",
                url: service + "/api/SubSection?subSectionId=" + subSectionId,
                success: function (subSection) {
                    $('#subSectionRow').show();
                    $('#txtSubSectionTitle').val(subSection.SubSectionTitle);
                    $('#txtSubSectionOrder').val(subSection.SubSectionOrder);
                    $('#sectionEditor').summernote('code', subSection.SubSectionContents);

                    subSectionModel.Id = subSection.Id;
                    $('#txtSectionTitle').val(subSection.SectionTitle);
                    $('#txtSectionOrder').val(subSection.SectionOrder);

                    $('#btnAddUpdateSubSection').show().html("Update SubSection");
                    $('#btnAddUpdateSection').hide();
                    $('#btnNewSection').hide();
                    $('#btnNewSubSection').show().html("New SubSection");;
                },
                error: function (jqXHR, exception) {
                    alert("loadSubSectionDetails XHR error: " + getXHRErrorDetails(jqXHR, exception));
                }
            });
        } catch (e) {
            alert("loadSubSectionDetails CATCH: " + e);
        }
    }
    function addUpdateSubSection() {
        if ($('#btnAddUpdateSubSection').html() == "New Subsection") {
            $('#subSectionRow').show();
            $('#btnNewSection').hide()
            $('#btnAddUpdateSection').hide()
            $('#btnNewSubSection').html("Cancel")
            $('#btnNewSubSection').show()
            $('#btnAddUpdateSubSection').html("Save Subsection")
            // clear gets
            $('#sectionEditor').summernote('code', "");
            //$('#txtSectionTitle').val("");
            //$('#txtSectionOrder').val("");
            $('#txtSubSectionTitle').val("");
            $('#txtSubSectionOrder').val("");
        }
        else {
            subSectionModel.Section = sectionModel.Id;
            subSectionModel.SubSectionTitle = $('#txtSubSectionTitle').val();
            subSectionModel.SubSectionOrder = $('#txtSubSectionOrder').val();
            subSectionModel.SubSectionContents = $('#sectionEditor').summernote('code');
            if ($('#btnAddUpdateSubSection').html() == "Save Subsection") {
                try {
                    $.ajax({
                        type: "POST",
                        url: service + "/api/SubSection/",
                        data: subSectionModel,
                        success: function (subSectionId) {
                            subSectionModel.Id = subSectionId;
                            displayStatusMessage("ok", subSectionModel.SubSectionTitle + " Added");
                            $('#btnAddUpdateSubSection').html("Update Subsection");
                            $('#btnNewSubSection').html("New Subsection").show();
                            loadSectionList();
                        },
                        error: function (jqXHR, exception) {
                            alert("addSection XHR error: " + getXHRErrorDetails(jqXHR, exception));
                        }
                    });
                } catch (e) {
                    alert("addSection CATCH: " + e);
                }
            }
            if ($('#btnAddUpdateSubSection').html() == "Update SubSection") {
                try {
                    $.ajax({
                        type: "PUT",
                        url: service + "/api/SubSection/",
                        data: subSectionModel,
                        success: function (success) {
                            if (success == "ok") {
                                displayStatusMessage("ok", subSectionModel.SubSectionTitle + " Updated");
                                loadSectionList();
                            }
                            else
                                alert("success: " + success);
                        },
                        error: function (jqXHR, exception) {
                            alert("getChapter XHR error: " + getXHRErrorDetails(jqXHR, exception));
                        }
                    });
                } catch (e) {
                    alert("updateSection CATCH: " + e);
                }
            }
        }
    }
    function toggleNewSubSection() {
        if ($('#btnNewSubSection').html() == "Cancel") {
            // go back to section
            //alert("sectionModel.Id :" + sectionModel.Id)
            //loadSectionDetails(sectionModel.Id);
        }
        if ($('#btnNewSubSection').html() == "New SubSection") {
            $('#txtSubSectionTitle').val('');
            $('#txtSubSectionOrder').val('');
            $('#sectionEditor').summernote('code', "");
            $('#btnAddUpdateSubSection').show().html("Add");
            $('#btnNewSubSection').html("Cancel");
        }
    }

    function loadNestedList() {
        try {
            $('#writeSectionsListLoadingGif').show();
            $.ajax({
                type: "get",
                url: service + "/api/BookDb/?bookId=" + bookId,
                success: function (book) {
                    bookModel.Id = book.Id;
                    bookModel.BookTitle = book.BookTitle;
                    $('#pageBookTitle').html(bookModel.BookTitle);
                    bookModel.Introduction = book.Introduction;
                    bookModel.Preface = book.Preface;
                    bookModel.Chapters = new Array();
                    $('#nestedBookChaptersList').html("<div class='nestedListBookItem nestedListItem' onclick='loadBookDetails()'>" + bookModel.BookTitle + "</div>");

                    $.each(book.Chapters, function (idx, dbChapter) {
                        var chapterModel = new Object();
                        chapterModel.Array = new Object();
                        chapterModel.Id = dbChapter.Id;
                        chapterModel.ChapterTitle = dbChapter.ChapterTitle;
                        chapterModel.ChapterOrder = dbChapter.ChapterOrder;
                        chapterModel.Preface = dbChapter.Preface;

                        var chapterLine = "<div class='chapterContainer nestedListItem'>"
                        chapterLine += "<div class='nestedListChapterItem' onclick='loadChapterDetails(" + dbChapter.Id + ")' >";
                        chapterLine += dbChapter.ChapterOrder + " | " + dbChapter.ChapterTitle + "</div>";
                        chapterLine += "<div class='dots' onclick='toggleNestedSection(" + dbChapter.Id + ")'></div>";
                        //chapterLine += "<div class='dots' onclick='$(#chapterContainer" + dbChapter.Id + ").slideToggle()'></div>";
                        chapterLine += "<div><img class='caret12' onclick='toggleNestedSection(" + dbChapter.Id + ")' src='/Images/caretDown.png'></div></div>";
                        //chapterLine += "<div><img class='caret12' onclick='$('#chapterContainer" + dbChapter.Id + "').slideToggle()' src='/Images/caretDown.png'></div></div>";
                        chapterLine += "<div id=chapterContainer" + dbChapter.Id + " class='collapsible' ></div>";
                        $('#nestedBookChaptersList').append(chapterLine);

                        $.each(dbChapter.Sections, function (idx, dbSection) {
                            var sectionModel = new Object();
                            sectionModel.SubSections = new Array();
                            sectionModel.Id = dbSection.Id;
                            sectionModel.SectionTitle = dbSection.SectionTitle;
                            sectionModel.SectionOrder = dbSection.SectionOrder;
                            sectionModel.SectionContents = dbSection.SectionContents;

                            var sectionLine = "<div class='chapterContainer nestedListItem'>"
                            sectionLine += "<div class='nestedListSectionItem' onclick='loadSectionDetails(" + dbChapter.Id + "," + dbSection.Id + ")'>";
                            sectionLine += dbSection.SectionOrder + " | " + dbSection.SectionTitle + "</div>";
                            sectionLine += "<div class='dots95' onclick='toggleNestedSUBSection(" + dbSection.Id + ")'></div>";
                            //sectionLine += "<div class='dots95' onclick='$('#sectionContainer" + dbSection.Id + "').slideToggle()'></div>";
                            sectionLine += "<div><img class='caret12' onclick='toggleNestedSUBSection(" + dbSection.Id + ")' src='/Images/caretDown.png'></div></div>";
                            //sectionLine += "<div><img class='caret12' onclick='$('#sectionContainer" + dbSection.Id + "').slideToggle()' src='/Images/caretDown.png'></div></div>";
                            sectionLine += "<div id=sectionContainer" + dbSection.Id + " class='collapsible' ></div>";
                            $('#chapterContainer' + dbChapter.Id + '').append(sectionLine);

                            $.each(dbSection.SubSections, function (idx, dbSubSection) {
                                var subSectionModel = new Object();
                                subSectionModel.Id = dbSubSection.Id;
                                subSectionModel.Contents = dbSubSection.SubSectionContents;
                                subSectionModel.Title = dbSubSection.SubSectionTitle;
                                subSectionModel.Order = dbSubSection.SubSectionOrder;
                                $('#sectionContainer' + dbSection.Id + '').append("<div subSectionId=" + dbSubSection.Id + "' sectionId=" +
                                    dbSection.Id + " class='nestedListItem nestedListSubSectionItem' >" + dbSubSection.SubSectionOrder + " | " + dbSubSection.SubSectionTitle + "</div>");

                                //sectionModel.SubSections.push(subSectionModel);
                            });
                            //chapterModel.Sections.push(sectionModel);
                        });
                        // bookModel.Chapters.push(chapterModel);
                    });

                    $('.nestedListSubSectionItem').click(function () {
                        alert("nestedListSubSectionItem sectionId: (" + $(this).attr("sectionId") + ") SUBsectionId: (" + $(this).attr("subSectionId") + ")  go edit");
                        //    $('#sectionContainer' + $(this).attr("id") + '').slideToggle();
                    })
                    resizePage();
                    $('#writeSectionsListLoadingGif').hide();
                },
                error: function (jqXHR, exception) {
                    alert("loadSectionList XHR error: " + getXHRErrorDetails(jqXHR, exception));
                    $('#writeSectionsListLoadingGif').hide();
                }
            });
        } catch (e) {
            $('#writeSectionsListLoadingGif').hide();
            alert("loadSectionList CATCH: " + e);
        }
    }
    function toggleNestedSUBSection(sectionId) {
        $('#sectionContainer' + sectionId + '').slideToggle();
    }
    function toggleNestedSection(chapterId) {
        $('#chapterContainer' + chapterId + '').slideToggle();
    }

    function redirectToToC() {
        window.location.href = "/BookDb/Toc?book=" + bookId;
    }
    function redirectToEdit() {
        window.location.href = "/BookDb/Edit?book=" + bookId;
    }

</script>