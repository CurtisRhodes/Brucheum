
@{
    ViewBag.Title = "Upload Image Test";
}

<style>
    #bImage {
        height: 300px;
        width: 800px;
        border: solid thin black;
    }

    #btnGet {
        display: inline;
    }
</style>


<div id="divStatusMessage"></div>

<h2>Image Test</h2>

<button id="btnGet">Get Test</button>
<input id="bUpload" size="110" type="file" />
<img id="bImage" />

<script>
    var webApiUrl = "/api/Images";

    $('#btnGet').click(function () {
        var image = retrieveImage("WYNYz7DWrFkt.jpg")
        //alert("image2: " + image);
        $('#bImage').attr("src", "data:image/gif;base64," + image);
    })

    $('#bUpload').change(function () {
        upLoadImage();
    })

    function upLoadImage() {
        try {
            var fileName = $('#bUpload').val();
            fileName = fileName.substring(fileName.lastIndexOf("\\") + 1);

            var image = $('#bUpload')[0].files[0];

            if (image != null) {
                $.ajax({
                    url: webApiUrl,
                    type: "post",
                    enctype: 'multipart/form-data',
                    processData: false,  // Important!
                    contentType: false,
                    cache: false,
                    data: image,
                    success: function (data) {
                        displayStatusMessage("alert-success", data + " Image Uploaded");
                        $('#bImage').attr("src", URL.createObjectURL(image));
                    },
                    error: function (xhr, textStatus, error) {
                        displayStatusMessage("alert-danger", "ERROR: " + xhr.statusText + ": " + textStatus);
                        alert("ajax post ERROR: " + xhr.statusText + ": " + textStatus)
                    }
                })
            }
            else {
                alert("ERROR: image == null")
                displayStatusMessage("alert-danger", "ERROR: not working");
            }
        } catch (e) {
            displayStatusMessage("alert-danger", "ERROR t: " + e);
            alert("try catch ERROR : " + e);
        }

    };

    function retrieveImage(imageName) {

        var bytes;
        $.ajax({
            url: webApiUrl + "?id=" + imageName,
            type: "get",
            async: false,
            processData: false,  // Important!
            contentType: false,
            success: function (data) {
                bytes = data;
            },
            error: function (xhr, textStatus, error) {
                displayStatusMessage("alert-danger", "ERROR: " + xhr.statusText + ": " + textStatus);
            }
        })
        return bytes;
    }

    function displayStatusMessage(severity, message) {
        $('#divStatusMessage').removeClass("alert-danger", "alert-success")
        $('#divStatusMessage').addClass(severity)
        $('#divStatusMessage').html(message);
        $('#divStatusMessage').show()
        if (severity == "alert-success")
            setTimeout(function () { $('#divStatusMessage').hide("slow") }, 5000);
    }
</script>

